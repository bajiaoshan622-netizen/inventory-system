<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº“å­˜ç®¡ç†ç³»ç»Ÿ - ç®¡ç†å‘˜</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* ç™»å½•é¡µ */
    .login-container {
      display: flex; align-items: center; justify-content: center; min-height: 100vh;
    }
    .login-box {
      background: white; padding: 40px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
    }
    .login-box h2 { margin-bottom: 24px; text-align: center; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #666; }
    .form-group input {
      width: 100%; padding: 10px 12px; border: 1px solid #d9d9d9;
      border-radius: 4px; font-size: 14px;
    }
    .btn {
      width: 100%; padding: 12px; background: #1890ff; color: white;
      border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
    }
    .btn:hover { background: #40a9ff; }
    .btn-danger { background: #ff4d4f; }
    .btn-danger:hover { background: #ff7875; }
    .btn-success { background: #52c41a; }
    .btn-success:hover { background: #73d13d; }
    .btn-warning { background: #fa8c16; }
    
    /* ä¸»ç•Œé¢ */
    .header {
      background: white; padding: 16px 24px; border-radius: 8px;
      margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .header h1 { font-size: 20px; }
    .header-actions { display: flex; gap: 12px; }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
    .stat-card {
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .stat-value { font-size: 28px; font-weight: 600; color: #1890ff; }
    .stat-label { font-size: 14px; color: #666; margin-top: 4px; }
    .stat-card.pending .stat-value { color: #fa8c16; }
    .stat-card.approved .stat-value { color: #52c41a; }
    
    /* ç­›é€‰æ  */
    .toolbar {
      background: white; padding: 16px; border-radius: 8px;
      margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .toolbar input, .toolbar select {
      padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px;
    }
    
    /* Tab */
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab {
      padding: 10px 20px; background: white; border: none; border-radius: 4px;
      cursor: pointer; font-size: 14px;
    }
    .tab.active { background: #1890ff; color: white; }
    
    /* è¡¨æ ¼ */
    .table-container {
      background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    th { background: #fafafa; font-weight: 500; }
    tr:hover { background: #fafafa; }
    .tag {
      padding: 2px 8px; border-radius: 4px; font-size: 12px;
      background: #e6f7ff; color: #1890ff;
    }
    .tag.pending { background: #fff7e6; color: #fa8c16; }
    .tag.approved { background: #f6ffed; color: #52c41a; }
    .actions { display: flex; gap: 8px; }
    .actions button { padding: 4px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; }
    
    /* å›¾ç‰‡é¢„è§ˆ */
    .img-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; }
    
    /* å¼¹çª— */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white; padding: 24px; border-radius: 8px;
      width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { margin: 0; }
    .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
    
    /* å¯¼å…¥ */
    .import-area { margin-top: 16px; }
    .import-area textarea {
      width: 100%; height: 200px; padding: 12px; border: 1px solid #d9d9d9;
      border-radius: 4px; font-family: monospace; font-size: 13px;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µ -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit" class="btn">ç™»å½•</button>
      </form>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="mainPage" class="container hidden">
    <div class="header">
      <h1>ğŸ“¦ åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
      <div class="header-actions">
        <button class="btn" onclick="showImportModal()" style="width: auto; padding: 8px 16px;">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button>
        <button class="btn btn-success" onclick="exportData()" style="width: auto; padding: 8px 16px;">ğŸ“¤ å¯¼å‡ºExcel</button>
        <button class="btn btn-danger" onclick="logout()" style="width: auto; padding: 8px 16px;">é€€å‡º</button>
      </div>
    </div>

    <!-- ç»Ÿè®¡ -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalCount">-</div>
        <div class="stat-label">æ€»è®°å½•æ•°</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-value" id="pendingCount">-</div>
        <div class="stat-label">å¾…å¤æ ¸</div>
      </div>
      <div class="stat-card approved">
        <div class="stat-value" id="approvedCount">-</div>
        <div class="stat-label">å·²ç¡®è®¤</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalWeight">-</div>
        <div class="stat-label">æ€»é‡é‡(å¨)</div>
      </div>
    </div>

    <!-- ç­›é€‰ -->
    <div class="toolbar">
      <input type="text" id="searchVehicle" placeholder="æœç´¢è½¦ç‰Œå·...">
      <select id="filterBatch">
        <option value="">å…¨éƒ¨åŒ…è£…</option>
        <option value="1å·è¢‹">1å·è¢‹</option>
        <option value="2å·è¢‹">2å·è¢‹</option>
        <option value="3å·è¢‹">3å·è¢‹</option>
        <option value="4å·è¢‹">4å·è¢‹</option>
        <option value="6å·è¢‹">6å·è¢‹</option>
      </select>
      <input type="date" id="startDate" placeholder="å¼€å§‹æ—¥æœŸ">
      <input type="date" id="endDate" placeholder="ç»“æŸæ—¥æœŸ">
      <button class="btn" onclick="loadData()" style="width: auto; padding: 8px 16px;">ğŸ” æŸ¥è¯¢</button>
    </div>

    <!-- Tab -->
    <div class="tabs">
      <button class="tab active" onclick="setTab('all')">å…¨éƒ¨</button>
      <button class="tab" onclick="setTab('pending_review')">å¾…å¤æ ¸</button>
      <button class="tab" onclick="setTab('approved')">å·²ç¡®è®¤</button>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å…¥åº“æ—¥æœŸ</th>
            <th>è½¦å·</th>
            <th>åŒ…è£…/æ‰¹å·</th>
            <th>å®æ”¶ä»¶æ•°</th>
            <th>å®æ”¶å¨æ•°</th>
            <th>æå•å·</th>
            <th>çŠ¶æ€</th>
            <th>å›¾ç‰‡</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>è®°å½•è¯¦æƒ…</h3>
        <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
      </div>
      <div id="detailContent"></div>
      <div class="actions" style="margin-top: 20px; justify-content: flex-end;">
        <button id="rejectBtn" class="btn btn-danger" onclick="rejectRecord()">é©³å›å¹¶åˆ é™¤</button>
        <button id="approveBtn" class="btn btn-success" onclick="approveRecord()">å¤æ ¸é€šè¿‡</button>
      </div>
    </div>
  </div>

  <!-- å¯¼å…¥å¼¹çª— -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ‰¹é‡å¯¼å…¥å†å²æ•°æ®</h3>
        <button class="close-btn" onclick="closeModal('importModal')">&times;</button>
      </div>
      <p>æ ¼å¼ï¼šJSON æ•°ç»„ï¼Œæ¯è¡Œä¸€ä¸ªå¯¹è±¡</p>
      <div class="import-area">
        <textarea id="importData" placeholder='[
  {
    "vehicle_id": "æ¡‚P58838",
    "package_batch": "å¤©å®è‹±æ–‡3å·è¢‹",
    "inbound_date": "2026-02-10",
    "actual_quantity": 700,
    "actual_weight": 35.11
  }
]'></textarea>
      </div>
      <div class="actions" style="margin-top: 16px;">
        <button class="btn btn-success" onclick="importData()">ç¡®è®¤å¯¼å…¥</button>
      </div>
    </div>
  </div>

  <!-- å›¾ç‰‡é¢„è§ˆ -->
  <div id="imageModal" class="modal" onclick="closeModal('imageModal')">
    <div style="max-width: 90%; max-height: 90%;">
      <img id="previewImage" src="" style="max-width: 100%; max-height: 90vh; border-radius: 8px;">
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let token = localStorage.getItem('admin_token');
    let currentTab = 'all';
    let currentRecord = null;

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (token) {
      showMainPage();
    }

    // ç™»å½•
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      
      const res = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      
      const data = await res.json();
      if (data.token) {
        token = data.token;
        localStorage.setItem('admin_token', token);
        showMainPage();
      } else {
        alert('å¯†ç é”™è¯¯');
      }
    };

    function showMainPage() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainPage').classList.remove('hidden');
      loadStats();
      loadData();
    }

    function logout() {
      localStorage.removeItem('admin_token');
      token = null;
      location.reload();
    }

    async function loadStats() {
      const res = await fetch(`${API_BASE}/admin/stats`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      document.getElementById('totalCount').textContent = data.total_records || 0;
      document.getElementById('pendingCount').textContent = data.pending_count || 0;
      document.getElementById('approvedCount').textContent = data.approved_count || 0;
      document.getElementById('totalWeight').textContent = (data.total_weight || 0).toFixed(2);
    }

    async function loadData() {
      const params = new URLSearchParams();
      if (currentTab !== 'all') params.append('status', currentTab);
      
      const vehicle = document.getElementById('searchVehicle').value;
      const batch = document.getElementById('filterBatch').value;
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      
      if (vehicle) params.append('vehicle', vehicle);
      if (batch) params.append('batch', batch);
      if (start) params.append('startDate', start);
      if (end) params.append('endDate', end);
      
      const res = await fetch(`${API_BASE}/admin/records?${params}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const { data } = await res.json();
      
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = data.map(row => `
        <tr>
          <td>${row.id}</td>
          <td>${row.inbound_date || '-'}</td>
          <td>${row.vehicle_id}</td>
          <td><span class="tag">${row.package_batch}</span></td>
          <td>${row.actual_quantity}</td>
          <td>${row.actual_weight}</td>
          <td>${row.bill_of_lading || '-'}</td>
          <td><span class="tag ${row.status}">${row.status === 'pending_review' ? 'å¾…å¤æ ¸' : 'å·²ç¡®è®¤'}</span></td>
          <td>${row.image_url ? `<img src="${row.image_url}" class="img-thumb" onclick="showImage('${row.image_url}')">` : '-'}</td>
          <td class="actions">
            <button onclick="showDetail(${row.id})" class="btn" style="width: auto; padding: 4px 12px;">æŸ¥çœ‹</button>
            ${row.status === 'pending_review' ? `
              <button onclick="approveRecord(${row.id})" class="btn btn-success" style="width: auto; padding: 4px 12px;">é€šè¿‡</button>
              <button onclick="rejectRecord(${row.id})" class="btn btn-danger" style="width: auto; padding: 4px 12px;">é©³å›</button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    function setTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      loadData();
    }

    async function showDetail(id) {
      const res = await fetch(`${API_BASE}/admin/records/${id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      currentRecord = await res.json();
      
      const content = document.getElementById('detailContent');
      content.innerHTML = `
        <p><strong>ID:</strong> ${currentRecord.id}</p>
        <p><strong>è½¦å·:</strong> ${currentRecord.vehicle_id}</p>
        <p><strong>åŒ…è£…:</strong> ${currentRecord.package_batch}</p>
        <p><strong>å…¥åº“æ—¥æœŸ:</strong> ${currentRecord.inbound_date}</p>
        <p><strong>å®æ”¶:</strong> ${currentRecord.actual_quantity}ä»¶ / ${currentRecord.actual_weight}å¨</p>
        <p><strong>æå•å·:</strong> ${currentRecord.bill_of_lading || '-'}</p>
        <p><strong>åˆåŒå·:</strong> ${currentRecord.contract_no || '-'}</p>
        <p><strong>å¤‡æ³¨:</strong> ${currentRecord.remarks || '-'}</p>
        <p><strong>çŠ¶æ€:</strong> ${currentRecord.status === 'pending_review' ? 'å¾…å¤æ ¸' : 'å·²ç¡®è®¤'}</p>
        <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${currentRecord.created_at}</p>
        ${currentRecord.image_url ? `<p><img src="${currentRecord.image_url}" style="max-width: 100%; border-radius: 4px; margin-top: 10px;"></p>` : ''}
      `;
      
      // æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—æŒ‰é’®
      const approveBtn = document.getElementById('approveBtn');
      const rejectBtn = document.getElementById('rejectBtn');
      if (currentRecord.status === 'pending_review') {
        approveBtn.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
      } else {
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
      }
      
      document.getElementById('detailModal').classList.add('show');
    }

    async function approveRecord(id) {
      const recordId = id || currentRecord?.id;
      if (!recordId) return;
      
      if (!confirm('ç¡®è®¤å¤æ ¸é€šè¿‡è¿™æ¡è®°å½•ï¼Ÿ')) return;
      
      await fetch(`${API_BASE}/admin/records/${recordId}/approve`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      closeModal('detailModal');
      loadData();
      loadStats();
    }

    async function rejectRecord(id) {
      const recordId = id || currentRecord?.id;
      if (!recordId) return;
      
      if (!confirm('ç¡®è®¤é©³å›è¿™æ¡è®°å½•ï¼Ÿè¿™å°†æ°¸ä¹…åˆ é™¤è¯¥è®°å½•ã€‚')) return;
      
      await fetch(`${API_BASE}/admin/records/${recordId}/reject`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      closeModal('detailModal');
      loadData();
      loadStats();
    }

    function showImportModal() {
      document.getElementById('importModal').classList.add('show');
    }

    async function importData() {
      const text = document.getElementById('importData').value;
      try {
        const records = JSON.parse(text);
        if (!Array.isArray(records)) throw new Error('å¿…é¡»æ˜¯æ•°ç»„');
        
        const res = await fetch(`${API_BASE}/admin/import`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ records })
        });
        
        const data = await res.json();
        alert(`æˆåŠŸå¯¼å…¥ ${data.imported} æ¡è®°å½•`);
        closeModal('importModal');
        loadData();
        loadStats();
      } catch (e) {
        alert('æ ¼å¼é”™è¯¯: ' + e.message);
      }
    }

    function exportData() {
      const params = new URLSearchParams();
      if (currentTab !== 'all') params.append('status', currentTab);
      
      window.open(`${API_BASE}/admin/export?${params}`, '_blank');
    }

    function showImage(url) {
      document.getElementById('previewImage').src = url;
      document.getElementById('imageModal').classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }
  </script>
</body>
</html>

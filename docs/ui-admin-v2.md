# UI: Admin v2（库存管理后台）

## 1. Target Architecture
- 单页管理台（Worker 内嵌前端）
- 信息架构以 Excel 认知模型为主：
  1) 入库台账（主视图）
  2) 可出库入库池（操作入口）
  3) 待审批区（Agent）

## 2. Route / Menu
- `/admin/ledger` 入出库台账（默认页）
- `/admin/outbound` 出库登记（从可出库入库池发起）
- `/admin/audit` 待审批入库

## 3. UI Spec

### 3.1 台账主表（直观）
主行展示“入库摘要 + 出库汇总 + 结余”：
- 入库列：入库日期、车号、批号、实收件数/吨数、异常字段
- 出库汇总列：最早出库日期、累计出库件数/吨数、出库笔数
- 结余列：库存件数、库存吨数

### 3.2 一对多出库可视化（必须）
每条入库主行支持展开（`展开按钮` 或 `抽屉`）查看 `outbounds[]` 明细：
- 子行字段：出库ID、出库日期、出库件数、出库吨数、备注、操作人
- 展开默认按出库时间倒序
- 子行汇总与主行 `outbound_summary` 一致

#### 3.2.1 未出库空态样式（不是“-”）
- 主行出库汇总区域显示灰底标签：`未出库`
- 展开区显示空态卡片：
  - 文案：`该入库记录暂未关联出库记录`
  - 次文案：`可在上方“出库登记”中选择本入库发起出库`
  - 图标：空盒子/托盘（弱化）

### 3.3 出库登记区
- 第一步：下拉选择“仍有库存”的入库记录（展示：入库ID + 批号 + 剩余件数/吨数）
- 第二步：填写出库日期、出库件数、出库吨数、备注
- 提交后刷新台账与可出库池

### 3.4 防错交互（必须）
1. 上限提示（输入时实时展示）
   - `本入库最多可出 {remaining_qty} 件 / {remaining_weight} 吨`
2. 超上限阻断文案
   - `出库数量超出上限：最多可出 {remaining_qty} 件，当前输入 {input_qty} 件`
   - `出库吨数超出上限：最多可出 {remaining_weight} 吨，当前输入 {input_weight} 吨`
3. 提交成功回显
   - Toast：`出库登记成功（出库ID: {id}），剩余 {remaining_qty} 件 / {remaining_weight} 吨`
4. 提交后定位
   - 自动滚动并高亮刚更新的入库主行（2.5 秒高亮淡出）
   - 若该行已展开，同步刷新其出库子行

### 3.5 待审批区
- 列表展示 Agent 待审批入库
- 提供附件查看、通过、驳回

## 4. Interaction Rules
1. 出库按钮仅在选中有效入库后可用
2. 选择入库后，自动展示该入库剩余库存提示
3. 超量提交在前端即时拦截；后端二次校验
4. 成功提示需包含“出库ID + 扣减后剩余库存”
5. 成功后必须定位并高亮对应入库主行

## 5. State Machine & Button Rules
- 选择入库前：提交按钮 disabled
- 已选择且输入合法：提交按钮 enabled
- 提交中：按钮 loading + 防重复提交
- 提交成功：清空表单并回到默认可出库第一项

## 6. Data Dictionary（关键前端字段）
- 可出库选项：`inbound_id, batch_no, category_name, remaining_qty, remaining_weight, inbound_date`
- 台账主行：`inbound + outbound_summary + remaining`
- 出库子行：`outbounds[]`

## 7. Empty/Error/Loading States
- 无可出库记录：显示“当前无可出库库存，请先完成入库或审批”
- 台账为空：显示“暂无入库数据”
- 未出库展开：显示空态卡片（见 3.2.1）
- 出库失败：显示后端错误（如“超出可用库存”）

## 8. Verification
- [ ] 用户无需手输 batch/category 即可完成出库
- [ ] 未出库记录主行显示“未出库”标签，展开显示空态卡片
- [ ] 一条入库可展开查看多条出库明细（outbounds[]）
- [ ] 出库超上限显示明确文案（含最大值/当前值）并阻断提交
- [ ] 出库成功后可定位并高亮对应入库行（2.5s）

## 9. Change Log
| 日期 | 变更 | 作者 |
|---|---|---|
| 2026-02-15 | 实现收口：主行展开明细、未出库空态卡片、超限动态文案、成功定位高亮 | 光年 |
| 2026-02-15 | 补充“入库一对多出库展开/抽屉”、“未出库空态”、“防错交互与成功定位高亮” | 光年 |
| 2026-02-15 | 重构信息架构为“台账主视图 + 可出库池出库”并补充状态规则 | 光年 |
| 2026-02-15 | Admin v2 交互设计初稿 | 光年 |

# Requirements - Inventory System Upgrade (v2)

## 1. 背景
当前系统仅完成了部分“入库”流程，字段不全，且未覆盖：
- 破损/污包/湿包/短少/多包登记
- 出库登记与库存校验
- 货类（Tab）通用化
- 多客户隔离管理

本次先产出方案与执行计划，不直接改代码。

## 2. Excel 现状（通过 DocSDK 读取）
数据源：`updated_inventory.xlsx`

### 2.1 Tab 清单
1. `50KG氢钙1号袋`
2. `25KG氢钙2号袋`
3. `50KG氢钙3号袋`
4. `50KG氢钙4号袋`
5. `50KG氢钙6号袋`
6. `50KG二氢钙1号袋`
7. `1000KG氢钙3号袋英文`
8. `换包记录`

### 2.2 统一字段主干（多数入出库 Tab）
- 序号、发车日期、入库日期、车号/箱号、包装/批号、发货含量
- 发车件数/吨数、实收件数/吨数
- 破包、污包、湿包、短少、（部分Tab存在多包/烂包）
- 提单号、合同号、装柜方式、装柜总件数/吨数、出库日期
- 库存件数/吨数、备注

### 2.3 数据结构差异（需要系统处理）
- `50KG氢钙3号袋` 出现重复表头区块（同一 sheet 中双表结构）
- 部分 Tab 额外字段：`多包`、`烂包`
- `换包记录` 为独立业务表，不等同于普通入/出库流水

## 3. 目标与范围

### 3.1 Goals
1. 补全入库字段，覆盖异常包登记（破/污/湿/短/多/烂）
2. 新增管理员“出库登记”
3. 出库必须做库存校验：不能超过可出库数量
4. 货类模型通用化：Tab 映射为可配置货类，后续新增货类无需改代码结构
5. 支持多客户（tenant）隔离的库存管理
6. 文档化交付：需求/方案/进度三件套持续同步

### 3.2 Non-Goals（本轮先不做）
- 不做复杂财务对账
- 不做外部ERP双向同步
- 不做自动排车/运输优化

## 4. 关键业务规则（拟定）
1. **可用件数规则（沿用已确认口径）**：`可用件数 = 实收件数`（不因破/污/湿/短/多自动扣减）
2. 出库校验：单次出库 + 历史累计出库，不得超过当前可用库存
3. 出库必须由管理员执行（Agent 无出库权限）
4. 入库/出库单均支持修改，并保留修改历史（字段级前后值）
5. 附件：
   - Agent 提交入库：附件必传
   - 管理员录入：支持上传（默认可选，后续可切换必传策略）

## 5. 多客户与货类模型（目标状态）

### 5.1 多客户（Tenant）
- 所有核心实体挂 `tenant_id`
- 查询默认按 tenant 隔离
- 管理员可在权限范围内切换 tenant

### 5.2 货类（Product Category）
- 将 Excel Tab 抽象为 `category`
- `category` 可配置字段模板（是否有多包/烂包）
- 新增货类通过配置/后台管理完成

## 6. 验收标准（DoD）
1. 入库表单可填写并保存全部异常字段
2. 管理员可发起出库并通过库存校验
3. 任意一条库存可追溯：入库 -> 出库 -> 结余
4. 至少支持 2 个 tenant 的隔离演示
5. 至少支持 2 个 category 配置差异演示
6. 文档齐全：`requirements.md`、`plan.md`、`progress.md`

## 7. 风险
- 历史 Excel 数据结构不一致，导入规则需容错
- 当前 schema 单表设计，升级到多租户+出库流水需迁移
- 可用件数口径与“质量扣减”口径可能冲突，需在策略层可配置

## 8. Change Log
| 日期 | 变更 | 作者 |
|---|---|---|
| 2026-02-15 | 初版需求文档（基于Excel全tab分析） | 光年 |
